<template>
  <div>
    <section v-if="form.error">
      <center>
        <img
          src="@/assets/no-data.png"
          style="height: 140px; margin-top: 70px"
        />
        <h4 style="color: black; margin-top: 30px">
          {{ $t("no_access_buddy") }}
        </h4>
      </center>
    </section>
    <section v-else>
      <div
        v-if="form.loading"
        style="
          font-size: 20px;
          justify-content: center;
          display: flex;
          margin-top: 60px;
          color: indianred;
        "
      >
        <center>
          <div
            class="spinner-border spinner-border-sm"
            style="width: 5rem; height: 5rem"
          ></div>
        </center>
      </div>

      <!-- Settings Body -->
      <transition name="fade">
        <div
          v-if="!form.loading"
          :style="{ padding: $device.mobile ? '0 50px 50px 50px' : '0 200px' }"
        >
          <p style="float: right">
            <strong>{{ $t("created_on") }} :</strong>
            {{ new Date(data.created_at).toDateString() }}
          </p>
          <h4>{{ $t("general_settings") }}</h4>
          <form v-on:submit.prevent="updateSettings">
            <div class="form-inline row">
              <label
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("display_title") }} :</label
              >
              <input
                type="text"
                class="form-control col-sm-8"
                id="title"
                :placeholder="$t('display_title')"
                required
                v-model="data.title"
              />
            </div>
            <div class="form-inline row">
              <label
                for="nickname"
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("surname") }} :</label
              >
              <input
                v-model="data.surname"
                type="text"
                class="form-control col-sm-8"
                disabled
                required
              />
            </div>
            <div class="form-inline row">
              <label
                for="pin"
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("admin_pin") }} :</label
              >
              <div class="col-sm-8 input-group p-0">
                <input
                  v-model="data.pin"
                  type="number"
                  class="form-control"
                  id="pin"
                  placeholder="Update 4 digit Admin PIN"
                  onkeypress="if(this.value.length==4) return false;"
                  max="9999"
                  :style="{
                    '-webkit-text-security': isPinHide.admin ? 'disc' : '',
                  }"
                  required
                />
                <div class="input-group-append">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    @click="isPinHide.admin = !isPinHide.admin"
                  >
                    <i
                      :class="
                        isPinHide.admin ? 'icofont-eye-blocked' : 'icofont-eye'
                      "
                    ></i>
                  </button>
                </div>
              </div>
            </div>
            <div
              v-if="data.pin == '1234' || data.pin == '0000'"
              class="mt-3 text-warning"
            >
              <div class="mb-2">{{ $t("pin_easy_guessed") }}</div>
            </div>
            <div class="form-inline row">
              <label
                for="view-pin"
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("view_only_pin") }} :</label
              >
              <div class="col-sm-8 input-group p-0">
                <input
                  v-model="data.view_pin"
                  type="number"
                  class="form-control"
                  id="view-pin"
                  :placeholder="$t('create_4_pin')"
                  onkeypress="if(this.value.length==4) return false;"
                  max="9999"
                  :style="{
                    '-webkit-text-security': isPinHide.view ? 'disc' : '',
                  }"
                />
                <div class="input-group-append">
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    @click="isPinHide.view = !isPinHide.view"
                  >
                    <i
                      :class="
                        isPinHide.view ? 'icofont-eye-blocked' : 'icofont-eye'
                      "
                    ></i>
                  </button>
                </div>
              </div>
            </div>
            <div
              v-if="data.view_pin == data.pin && data.pin"
              class="mt-3 text-danger"
            >
              <div class="mb-2">Admin PIN and View-Only PIN cannot be same</div>
            </div>
            <h4 class="contact-details">
              {{ $t("contact_details") }}
              <span>({{ $t("optional") }})</span>
            </h4>
            <div class="form-inline row">
              <label
                for="name"
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("your_name") }} :</label
              >
              <input
                type="text"
                class="form-control col-sm-8"
                id="name"
                v-model="data.contact.name"
                :placeholder="$t('your_name')"
              />
            </div>

            <div class="form-inline row">
              <label
                for="email"
                class="col"
                style="justify-content: left"
                v-if="!$device.mobile"
                >{{ $t("your_email") }} :</label
              >
              <input
                type="email"
                class="form-control col-sm-8"
                id="email"
                v-model="data.contact.email"
                :placeholder="$t('your_email')"
              />
            </div>
            <div
              style="
                display: flex;
                margin-top: 30px;
                justify-content: space-between;
              "
            >
              <div>
                <!-- data.pin.length != 4 || -->
                <button
                  type="submit"
                  class="btn btn-success"
                  :disabled="
                    form.isUpdating ||
                    data.pin == data.view_pin ||
                    data.pin.length != 4
                  "
                >
                  <span
                    class="spinner-border spinner-border-sm"
                    v-show="form.isUpdating"
                    style="margin-right: 8px"
                  ></span>
                  {{ $t("update") }}
                </button>
              </div>
            </div>
            <div v-if="form.error" class="mt-3 text-danger">
              <div class="mb-2">Error : {{ form.error }}</div>
            </div>
          </form>
          <h4 style="color: red; margin-top: 40px">{{ $t("danzer_zone") }}</h4>
          <div class="danger-zone">
            <h5>{{ $t("delete_family_permanently") }}</h5>
            <h6 class="mt-3">
              {{ $t("please_enter") }}
              <code>{{ this.$route.params.id }}</code>
              {{ $t("in_the_input_delete_family") }}
            </h6>
            <input
              class="form-control input-lg"
              type="text"
              v-model="deleteSurname"
            />
            <button
              :disabled="
                deleteSurname != this.$route.params.id || deletingFamily
              "
              class="btn btn-danger mt-3"
              @click="deleteFamily"
            >
              <span
                class="spinner-border spinner-border-sm"
                v-show="deletingFamily"
                style="margin-right: 8px"
              ></span
              >{{ $t("delete_family_permanently") }}
            </button>
          </div>

          <div class="mt-5">
            {{ $t("any_trouble") }}
            <a href="mailto:hello@bloodline.app">hello@bloodline.app</a>
          </div>
        </div>
      </transition>
    </section>
  </div>
</template>

<script>
import Axios from "axios";
import ProdData from "@/data.js";
import Store from "@/store/index";

export default {
  data() {
    return {
      form: {
        error: false,
        loading: true,
        isUpdating: false,
      },
      data: {
        contact: {},
        pin: "",
      },
      isPinHide: {
        admin: true,
        view: true,
      },
      deletingFamily: false,
      deleteSurname: "",
    };
  },
  mounted() {
    Axios.get(ProdData.getHostURL() + "/meta/get/" + this.$route.params.id)
      .then((data) => {
        this.data = data.data;
        if (!this.data.contact) {
          this.data.contact = {};
        }
      })
      .catch((err) => (this.form.error = err))
      .finally(() => (this.form.loading = false));
  },
  methods: {
    updateSettings() {
      this.form.isUpdating = true;
      Axios.put(ProdData.getHostURL() + "/meta/update", {
        title: this.data.title,
        _id: this.data._id,
        created_at: this.data.created_at,
        pin: this.data.pin,
        view_pin: this.data.view_pin,
        contact: this.data.contact,
      })
        .then(() => {
          if (Store.state.title != this.data.title) {
            Store.dispatch("setTitle", this.data.title);
          }
        })
        .catch((err) => (this.form.error = err))
        .finally(() => (this.form.isUpdating = false));
    },
    deleteFamily() {
      this.deletingFamily = true;
      Axios.delete(ProdData.getHostURL() + "/meta", {
        data: { surname: this.$route.params.id },
      })
        .then((data) => console.log(data))
        .catch((err) => console.log(err))
        .finally(() => {
          this.$router.push({ name: "Home" });
        });
    },
  },
};
</script>

<style scoped>
.contact-details {
  margin-top: 70px;
  display: flex;
  align-items: center;
}
.contact-details span {
  margin-left: 10px;
  font-size: 15px;
  color: grey;
}
.danger-zone {
  background-color: rgba(255, 191, 191, 0.2);
  border: solid #ffb6b6 1px;
  border-radius: 10px;
  padding: 20px;
  margin: 10px -25px;
}

.form-inline {
  margin-top: 20px;
}
</style>